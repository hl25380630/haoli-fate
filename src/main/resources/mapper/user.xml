<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.haoli.fate.dao.UserDao">

	<sql id="CommonUpdate">
		<if test="avatar != null and avatar != ''">
			avatar = #{avatar},
		</if>
		<if test="userName != null and userName != ''">
			userName = #{userName},
		</if>
		<if test="email != null and email != ''">
			email = #{email},
		</if>
	</sql>
	
	<sql id="CommonQuery">
        <if test="id != null ">
            and id=#{id}
        </if>
		<if test="userName != null and userName != '' ">
			and userName like '%${userName}%'
		</if>
		<!-- 按时间段查询 -->
		<if test="startDate != null and startDate != '' ">
            and startDate <![CDATA[>]]> #{createTime}
        </if>
        <if test="endDate != null and endDate != '' ">
            and endDate <![CDATA[<]]> #{createTime}
        </if>
    </sql>
	
	<select id="queryUser" parameterType="java.util.Map" resultType="com.haoli.fate.domain.User">
		select * from
			t_user
		<where>
			<include refid="CommonQuery"/>
		</where>
	</select>

	<insert id="add" parameterType="com.haoli.fate.domain.User">
		insert into
			t_user(
				userName,
				password,
				salt,
				phone,
				email,
				createTime
			)values(
				#{userName},
				#{password},
				#{salt},
				#{phone},
				#{email},
				#{createTime}
			)
	</insert>
	
	<update id="update" parameterType="java.util.Map">
		update
			t_user
		<set>
			<include refid="CommonUpdate"/>
			updateTime = #{updateTime}
		</set>
		where
			id = #{userId}
	</update>
	
	<select id="loadById" parameterType = "java.lang.Long" resultType="com.haoli.fate.domain.User">
		select
		    id,
		    phone,
		    avatar,
		    email,
		    userName,
		    password,
		    salt
		from
			t_user
		where
		    id=#{id}
	</select>
	
	<update id="resetPwd" parameterType = "com.haoli.fate.domain.User">
		update
			t_user
    	set
			salt=#{salt},
			password=#{password},
    		updateTime = #{updateTime}
		where
			id = #{id}
	</update>
	
	<select id="loadUserByPhone"  parameterType="java.lang.String" resultType="com.haoli.fate.domain.User">
    	select 
    		id,
		    phone,
		    userName,
		    password,
		    salt
    	from
    		t_user
    	where
    		phone=#{phone}
    </select>
    
    <select id="getUserInviteGuestNo" parameterType="java.util.Map" resultType="java.lang.Long">
    	select
    		count(1)
    	from
    		t_guest
    	where
    		conferenceId = #{conferenceId}
    		and createUserId = #{userId}
    </select>
    
    <select id="getUserInviteAgentQuota" parameterType="java.util.Map" resultType="java.lang.Long">
    	select
    		sum(totalAmount)
    	from
    		t_agent
    	where
    		conferenceId = #{conferenceId}
    		and inviteBy = #{userId}
    </select>
    
    <select id="batchGetUser" parameterType="java.util.Map" resultType="com.haoli.fate.domain.User">
 		select
	        id,
	        phone,
	        userName,
	        createTime,
	        updateTime
	    from
	        t_user
	    where
	        <if test="userIdList != null and userIdList.size != 0 ">
				id in
				<foreach collection="userIdList" item="userId" index="index" open="(" close=")" separator=",">
					#{userId}
				</foreach>
			</if>
    </select>
	
</mapper>